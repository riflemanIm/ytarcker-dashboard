<!-- русский -->

Этот документ на русском.
See the English version in [README.md](README.md).



# YTracker-Dashboard

Этот проект предоставляет минимальную настройку для запуска React в Vite с поддержкой HMR и базовыми правилами ESLint.

В данный момент доступны два официальных плагина:

* [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react/README.md) — использует Babel для Fast Refresh
* [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react-swc) — использует SWC для Fast Refresh

## О проекте

В YTracker-Dashboard вы можете отслеживать время, затраченное на выполнение задач.
Отслеживание времени помогает точнее планировать сроки и бюджеты проектов, а также выявлять узкие места при работе над задачами.

Для удобного учёта предоставлен специальный компонент **TaskTable**, который визуально показывает распределение рабочего времени по задачам в разрезе дней недели. Этот компонент позволяет быстро анализировать, сколько часов потрачено на каждую задачу и за каждый день недели.

Компонент TaskTable поддерживает интерактивное редактирование данных прямо в таблице, автоматически проверяет и преобразует введённые значения в корректный формат длительности (например, можно вводить `1d`, `2h`, `30m`), а также подсвечивает некорректные значения, помогая избежать ошибок. Благодаря этому команда может оперативно контролировать рабочее время и принимать обоснованные решения по управлению проектом.

---

## Функциональность

Ниже приведён обзор всей функциональности YTracker-Dashboard:

* **Аутентификация через Yandex OAuth**
  Пользователи входят через свой аккаунт Яндекса с помощью OAuth для безопасного получения и управления задачами.

* **Автоматический импорт задач**
  После входа в систему дашборд получает список ваших задач из Yandex Tracker, включая `key`, `summary` и поля группировки.

* **Гибкий ввод времени**

  * **Диалог быстрого добавления** для ручного ввода учёта времени: выбор задачи, даты и времени, ввод длительности (поддерживаются форматы `1d`, `2h`, `30m`) и добавление комментария.
  * **Встроенное меню в ячейках** TaskTable для редактирования, добавления или удаления одного или нескольких записей времени для дня/задачи.

* **Интерактивная таблица задач**

  * **Семь колонок** для каждого дня недели и **колонка «Итого»**, генерируются динамически.
  * **Группировка** записей работы по ключу задачи и имени группы.
  * **Суммирование** длительностей по задачам и по дням, с итоговой строкой внизу.
  * **Подсветка текущего дня** для быстрого обнаружения столбца «сегодня».
  * **Сортировка** по значению длительности с помощью ISO-совместимого компаратора.

* **Проверка и нормализация данных**

  * Мгновенная валидация формата ввода длительности.
  * Автоматическое преобразование и нормализация вводимых значений (например, `1h30m`) в единый формат.

* **Навигация по неделям**

  * Встроенный **WeekNavigator** для переключения вперёд или назад на одну неделю.
  * Автоматическая перезагрузка данных при смене недели.

* **Режимы просмотра**

  * Переключение между просмотром **своего** времени и **времени команды**.
  * **Автозаполнение** при выборе сотрудников в режиме «по пользователю».

* **Живые обновления и уведомления**

  * **Индикатор прогресса** во время получения данных.
  * **Snackbar** для вывода сообщений об успехе, ошибках или валидации (например, «Данные сохранены», «Неверный формат длительности» и т.д.).

* **TypeScript и Material-UI**
  Разработано с использованием React + Vite, TypeScript, компонентов Material-UI (DataGrid, Dialogs, Pickers) и dayjs для работы с датами.

---

## Режимы просмотра (меню)

В верхнем меню доступны 4 режима (`ViewMode`):

* **Списания** (`table_time_spend`) — недельная таблица списаний с интерактивным добавлением/редактированием, итогами по дням и задачам.
* **Планирование** (`table_time_plan`) — планирование по спринту с фильтрами (спринт, группа, роль, проект, исполнитель) и данными по плану/ёмкости.
* **Месячный отчёт** (`report`) — отчёт за месяц по неделям (только для администраторов).
* **Поиск по задачам** (`search`) — полнотекстовый поиск по задачам/очередям с деталями и комментариями.

Таблицы в режиме «Планирование»:
* **Подбор задач в план** (TableCheckPlan) — список задач-кандидатов с фильтром, просмотром информации по задаче и действием «добавить в план».
* **Загрузка сотрудников** (TableWorkPlanCapacity, админ) — план/факт/остаток по спринту, сотруднику и роли за выбранный период.
* **План работ** (TableWorkPlan) — элементы плана с приоритетами, дедлайнами, оценкой, фактом/остатком, исполнителем и статусом; админ может редактировать/удалять, не‑админ может добавлять отметки времени.
* **Затраченное время по плану** (TableTimeSpendByPlan) — показывает только списания по задачам из плана, с итогами по дням; редактирование доступно только в режиме не‑админа.

---

## Режим администратора (`isAdmin` / `planEditMode`)

Права администратора задаются флагом `isAdmin` (приходит из TL user info).

**Если `isAdmin = false`**
* Нет админ‑переключателя в шапке.
* Режим `report` скрыт.
* В планировании видны только **План работ** и **Затраченное время по плану**, редактирование отметок времени доступно.

**Если `isAdmin = true`**
* В шапке доступен **админ‑переключатель** (FetchModeSwitch), который включает `showAdminControls`.
* Режим `report` доступен.
* В **table_time_spend** можно переключаться между своими данными и выбранным сотрудником.
* В **table_time_plan** доступны доп. фильтры (группа, пациент, роль, проект), а также таблицы **Подбор задач в план** и **Загрузка сотрудников**.

**Если `planEditMode = true` (только админ)**
* Интерфейс принудительно открывает **Планирование** (режим списаний скрыт в меню).
* **План работ** становится редактируемым (добавление/правка/удаление записей плана).

---

## Настройка окружения

Создайте файл `.env` в корне проекта и задайте следующие переменные:

```dotenv
VITE_APP_CLIENT_ID=xxxxxxxxxxx
VITE_APP_REDIRECT_URI=https://ytracker.mobimed.ru
VITE_APP_API_URL=https://ytracker.mobimed.ru
```

Где:

* `VITE_APP_CLIENT_ID` — идентификатор OAuth-приложения Яндекса.
* `VITE_APP_REDIRECT_URI` — URL для перенаправления после авторизации.
* `VITE_APP_API_URL` — базовый URL вашего API-доступа.

---

## Методы API

Все методы предоставляет прокси-сервер (порт 4000).  
Аутентификация: `token` (OAuth) передаётся либо в query (GET), либо в теле (POST/PATCH).

Отметки времени сохраняются **и** в Yandex Tracker, **и** во внутреннюю PMT-базу.  
Эту синхронизацию выполняет эндпоинт `/api/worklog_update`.

### **GET `/api/issues`**
Получает записи работы за период.  
**Параметры запроса**:  
- `token` (обязательный)  
- `startDate` (YYYY-MM-DD, обязательный)  
- `endDate` (YYYY-MM-DD, обязательный) → сервер добавляет `T23:59`  
- `userId` (опционально) — фильтр по автору (ID)  
- `login` (опционально) — фильтр по автору (логин)  

**Ответ**
```json
{
  "data": [ /* массив worklog */ ],
  "users": [
    { "id": "123", "name": "Иван Иванов" }
  ]
}
```

---

### **POST `/api/worklog_update`**
Единая точка для добавления/редактирования/удаления worklog в Yandex Tracker и синхронизации TL.

**Параметры тела (основные)**
- `token` (string, обязателен для операций с Tracker; может отсутствовать для внутренних)
- `taskKey` (string, обязателен)
- `action` (number, обязателен) — `0` добавить, `1` изменить, `2` удалить
- `duration` (number или string, обязателен для add/edit)
- `start` (YYYY-MM-DDTHH:mm, обязателен для add)
- `startDate` (YYYY-MM-DD или YYYY-MM-DDTHH:mm, обязателен для внутренних)
- `comment` (string, обязателен)
- `worklogId` (number, обязателен для edit/delete)
- `worklogIdInternal` (number, опционально)
- `trackerUid` (string, обязателен для внутренних)
- `checklistItemId` (string, опционально)
- `issueTypeLabel` (string, опционально)
- `workPlanId` (string или number, опционально)
- `deadlineOk`, `needUpgradeEstimate`, `makeTaskFaster` (boolean, обязательны для внутренних)
- `items` (array, опционально) — пакетное удаление (объекты с `worklogId`, `duration`, `startDate`, `comment`, опц. `checklistItemId`)

**Ответ** → созданный/обновлённый worklog или `true` при удалении.

---

### **GET `/api/user_issues`**
Возвращает список задач, назначенных пользователю или созданных им, без дублей.  
**Параметры запроса**: token, userId или login.  

**Ответ**
```json
{
  "issues": [
    { "key": "PROJ-123", "summary": "Исправить баг авторизации" }
  ]
}
```

---

### **GET `/api/queues`**
Возвращает список очередей.  
**Параметры запроса**: `token` (string, обязателен).  
**Ответ** → `{ "queues": [{ "id": "1", "key": "ABC", "name": "Команда ABC" }] }`.

---

### **GET `/api/search_issues`**
Полнотекстовый поиск по строке и очереди.  
**Параметры запроса**
- `token` (string, обязателен)
- `search_str` (string, обязателен)
- `queue` (string, опционально, `"all"` чтобы отключить фильтр)
- `page` (number, опционально, по умолчанию 1)
- `per_page` или `perPage` (number, опционально, максимум 50)

**Ответ** → `{ issues, total, page, perPage, hasMore }`.

---

### **GET `/api/issue_type_list`**
Получает список типов задач для указанного entityKey.  
**Параметры запроса**: token, entityKey, email (все обязательные).  

> Для этого метода TLS-проверка отключена. Таймаут: 15 сек.

**Ответ**
```json
{
  "issue_type_list": [ /* ответ внешней системы */ ]
}
```

**Ошибки**
```json
{
  "error": "сообщение",
  "code": "ECONNABORTED",
  "upstreamStatus": 500,
  "upstreamData": { ... }
}
```

---

### **POST `/api/tl_userinfo`**
Получить информацию о пользователе по `trackerUid` или `email`.  
**Параметры тела**: `trackerUid` (string, опционально), `email` (string, опционально).

---

### **POST `/api/tl_sprints`**
Получить список спринтов.

---

### **POST `/api/tl_groups`**
Получить список групп.

---

### **POST `/api/tl_roles`**
Получить список ролей.

---

### **POST `/api/tl_projects`**
Получить список проектов.

---

### **POST `/api/tl_group_patients`**
Получить пациентов/исполнителей по группам.  
**Параметры тела**: `groupIds` (массив целых, обязателен).

---

### **POST `/api/tl_tasklist`**
Получить список задач по фильтрам.  
**Параметры тела**: `trackerUids` (string[]), `projectIds` (int[]), `roleIds` (int[]), `groupIds` (int[]).

---

### **POST `/api/tl_workplan`**
Получить план работ по спринту и фильтрам.  
**Параметры тела**: `sprintId` (int, обязателен), `trackerUids` (string[]), `projectIds` (int[]), `roleIds` (int[]), `groupIds` (int[]).

---

### **POST `/api/tl_workplan_capacity`**
Получить ёмкость плана работ за период и фильтры.  
**Параметры тела**: `dateStart` (string, обязателен), `dateEnd` (string, обязателен), `trackerUids` (string[]), `projectIds` (int[]), `roleIds` (int[]), `groupIds` (int[]).

---

### **POST `/api/setworkplan`**
Создать/изменить/удалить пункт плана.  
**Параметры тела**: `sprintId` (int, обязателен), `taskKey` (string, обязателен), `trackerUid` (string, обязателен), `action` (0/1/2, обязателен), `workPlanId` (int, обязателен для edit/delete), `checklistItemId`, `workName`, `deadline`, `estimateTimeMinutes`, `priority`.

---

### **POST `/api/task_plan_info`**
Получить информацию о плане задачи.  
**Параметры тела**: `taskKey` (string, обязателен).

---

### **POST `/api/yt_tl_checklist_data`**
Синхронизация/обновление данных чеклиста.  
**Параметры тела**: `entityKey` (string, обязателен), опционально `updatePlan`, `rePlan`, `synchronizePlan` (boolean).

---

Не стесняйтесь дорабатывать проект, пулреквесты приветствуются.
